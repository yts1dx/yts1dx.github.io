<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Oracle | Yan Tingshuai's Blog]]></title>
  <link href="http://yts1dx.github.io/blog/categories/oracle/atom.xml" rel="self"/>
  <link href="http://yts1dx.github.io/"/>
  <updated>2016-06-06T19:54:21+08:00</updated>
  <id>http://yts1dx.github.io/</id>
  <author>
    <name><![CDATA[Yan Tingshuai]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Use Oracle Explain]]></title>
    <link href="http://yts1dx.github.io/blog/2016/05/15/use-oracle-explain/"/>
    <updated>2016-05-15T20:08:21+08:00</updated>
    <id>http://yts1dx.github.io/blog/2016/05/15/use-oracle-explain</id>
    <content type="html"><![CDATA[<h2>生成explain</h2>

<pre><code>SQL&gt; explain plan into plan_table for  select /*+index(test testi) */ * from t1;

Explained.
</code></pre>

<h2>查看含有outline的explain</h2>

<pre><code>SQL&gt; select * from table(dbms_xplan.display('PLAN_TABLE',NULL,'OUTLINE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
Plan hash value: 3617692013

--------------------------------------------------------------------------
| Id  | Operation     | Name | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |  |     1 |    13 |     2   (0)| 00:00:01 |
|   1 |  TABLE ACCESS FULL| T1    |     1 |    13 |     2   (0)| 00:00:01 |
--------------------------------------------------------------------------

Outline Data
-------------

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------

  /*+
        BEGIN_OUTLINE_DATA
        FULL(@"SEL$1" "T1"@"SEL$1")
        OUTLINE_LEAF(@"SEL$1")
        ALL_ROWS
        DB_VERSION('11.2.0.2')
        OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
        IGNORE_OPTIM_EMBEDDED_HINTS
        END_OUTLINE_DATA
   */

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------

Note
-----
   - dynamic sampling used for this statement (level=2)

26 rows selected.
</code></pre>

<h2>index 的表现</h2>

<pre><code>    SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'OUTLINE'));

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    Plan hash value: 2965991605

    ---------------------------------------------------------------------------------
    | Id  | Operation    | Name     | Rows  | Bytes | Cost (%CPU)| Time |
    ---------------------------------------------------------------------------------
    |   0 | SELECT STATEMENT |      |     1 |    13 |     0   (0)| 00:00:01 |
    |   1 |  INDEX FULL SCAN | SYS_C0011876 |     1 |    13 |     0   (0)| 00:00:01 |
    ---------------------------------------------------------------------------------

    Outline Data
    -------------

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

      /*+
          BEGIN_OUTLINE_DATA
          INDEX(@"SEL$1" "T1"@"SEL$1" ("T1"."C1"))
          OUTLINE_LEAF(@"SEL$1")
          ALL_ROWS
          DB_VERSION('11.2.0.2')
          OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
          IGNORE_OPTIM_EMBEDDED_HINTS
          END_OUTLINE_DATA
      */

    22 rows selected.
</code></pre>

<p>IOT表的表现
    SQL> select * from     table(dbms_xplan.display(&lsquo;plan_table&rsquo;,NULL,&lsquo;OUTLINE&rsquo;));</p>

<pre><code>    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    Plan hash value: 900014233

    ------------------------------------------------------------------------------------------
    | Id  | Operation        | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
    ------------------------------------------------------------------------------------------
    |   0 | SELECT STATEMENT     |           |     1 |  1050 |   802   (0)| 00:00:10 |
    |   1 |  INDEX FAST FULL SCAN| PK_ADMIN_DOCINDEX |     1 |  1050 |   802   (0)| 00:00:10 |
    ------------------------------------------------------------------------------------------

    Outline Data
    -------------

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

      /*+
          BEGIN_OUTLINE_DATA
          INDEX_FFS(@"SEL$1" "ADMIN_DOCINDEX"@"SEL$1" ("ADMIN_DOCINDEX"."TOKEN"
              "ADMIN_DOCINDEX"."DOC_ID"))
          OUTLINE_LEAF(@"SEL$1")
          ALL_ROWS
          DB_VERSION('11.2.0.2')
          OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
          IGNORE_OPTIM_EMBEDDED_HINTS
          END_OUTLINE_DATA

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      */

    Note
    -----
       - dynamic sampling used for this statement (level=2)

    27 rows selected.
</code></pre>

<h2>涉及到rewrite时，hint中的qb_name</h2>

<pre><code>    SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'OUTLINE'));

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    Plan hash value: 1463220175

    -------------------------------------------------------------------------------------
    | Id  | Operation        | Name     | Rows  | Bytes | Cost (%CPU)| Time     |
    -------------------------------------------------------------------------------------
    |   0 | SELECT STATEMENT     |          |     1 |    13 |     0   (0)| 00:00:01 |
    |   1 |  MERGE JOIN CARTESIAN|          |     1 |    13 |     0   (0)| 00:00:01 |
    |   2 |   INDEX FULL SCAN    | SYS_C0011876 |     1 |    13 |     0   (0)| 00:00:01 |
    |   3 |   BUFFER SORT        |          |     1 |       |     0   (0)| 00:00:01 |
    |   4 |    INDEX FULL SCAN   | SYS_C0011877 |     1 |       |     0   (0)| 00:00:01 |
    -------------------------------------------------------------------------------------

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

    Outline Data
    -------------

      /*+
          BEGIN_OUTLINE_DATA
          USE_MERGE_CARTESIAN(@"SEL$F5BB74E1" "T2"@"SEL$2")
          LEADING(@"SEL$F5BB74E1" "T1"@"SEL$2" "T2"@"SEL$2")
          INDEX(@"SEL$F5BB74E1" "T2"@"SEL$2" ("T2"."C2"))
          INDEX(@"SEL$F5BB74E1" "T1"@"SEL$2" ("T1"."C1"))
          OUTLINE(@"SEL$2")

    PLAN_TABLE_OUTPUT
    --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
          OUTLINE(@"SEL$1")
          MERGE(@"SEL$2")
          OUTLINE_LEAF(@"SEL$F5BB74E1")
          ALL_ROWS
          DB_VERSION('11.2.0.2')
          OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
          IGNORE_OPTIM_EMBEDDED_HINTS
          END_OUTLINE_DATA
      */

    31 rows selected.
</code></pre>

<h2>多表join的情况</h2>

<pre><code class="sql">SQL&gt; explain plan into plan_table for select * from t1,t2,t3;

Explained.

SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'OUTLINE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 457197764

--------------------------------------------------------------------------------------
| Id  | Operation         | Name         | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT      |          |     1 |    39 |     2   (0)| 00:00:01 |
|   1 |  MERGE JOIN CARTESIAN |          |     1 |    39 |     2   (0)| 00:00:01 |
|   2 |   MERGE JOIN CARTESIAN|          |     1 |    26 |     0   (0)| 00:00:01 |
|   3 |    INDEX FULL SCAN    | SYS_C0011876 |     1 |    13 |     0   (0)| 00:00:01 |
|   4 |    BUFFER SORT        |          |     1 |    13 |     0   (0)| 00:00:01 |
|   5 |     INDEX FULL SCAN   | SYS_C0011877 |     1 |    13 |     0   (0)| 00:00:01 |

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   6 |   BUFFER SORT         |          |     1 |    13 |     2   (0)| 00:00:01 |
|   7 |    TABLE ACCESS FULL  | T3       |     1 |    13 |     2   (0)| 00:00:01 |
--------------------------------------------------------------------------------------

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_MERGE_CARTESIAN(@"SEL$1" "T3"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "T2"@"SEL$1")

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      LEADING(@"SEL$1" "T1"@"SEL$1" "T2"@"SEL$1" "T3"@"SEL$1")
      FULL(@"SEL$1" "T3"@"SEL$1")
      INDEX(@"SEL$1" "T2"@"SEL$1" ("T2"."C2"))
      INDEX(@"SEL$1" "T1"@"SEL$1" ("T1"."C1"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

33 rows selected.
</code></pre>

<h2>join含有view的情况</h2>

<pre><code>SQL&gt; explain plan into plan_table for select * from  t1, (select max(c2) from t2)  tt;

Explained.

SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'outline'));

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
Plan hash value: 3649077807

----------------------------------------------------------------------------------------------
| Id  | Operation             | Name         | Rows  | Bytes | Cost (%CPU)| Time     |
----------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT          |          |     1 |    26 |     1   (0)| 00:00:01 |
|   1 |  MERGE JOIN CARTESIAN         |          |     1 |    26 |     1   (0)| 00:00:01 |
|   2 |   INDEX FULL SCAN         | SYS_C0011876 |     1 |    13 |     0   (0)| 00:00:01 |
|   3 |   BUFFER SORT             |          |     1 |    13 |     1   (0)| 00:00:01 |
|   4 |    VIEW               |          |     1 |    13 |     1   (0)| 00:00:01 |
|   5 |     SORT AGGREGATE        |          |     1 |    13 |        |      |

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
|   6 |      INDEX FULL SCAN (MIN/MAX)| SYS_C0011877 |     1 |    13 |     1   (0)| 00:00:01 |
----------------------------------------------------------------------------------------------

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      INDEX(@"SEL$2" "T2"@"SEL$2" ("T2"."C2"))
      USE_MERGE_CARTESIAN(@"SEL$1" "TT"@"SEL$1")
      LEADING(@"SEL$1" "T1"@"SEL$1" "TT"@"SEL$1")

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
      NO_ACCESS(@"SEL$1" "TT"@"SEL$1")
      INDEX(@"SEL$1" "T1"@"SEL$1" ("T1"."C1"))
      OUTLINE_LEAF(@"SEL$1")
      OUTLINE_LEAF(@"SEL$2")
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

32 rows selected.
</code></pre>

<h2>busy tree</h2>

<pre><code class="sql">SQL&gt; explain plan into plan_table for select */*+leading(tt, t1,t2) use_nl(t1) use_nl(t2)*/ from (select /*+NO_MERGE*/* from t3,t4) tt, t1,t2;

Explained.

SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'outline'));

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
Plan hash value: 276994482

--------------------------------------------------------------------------------
| Id  | Operation       | Name | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |      |     1 |    52 |     8   (0)| 00:00:01 |
|   1 |  MERGE JOIN CARTESIAN   |      |     1 |    52 |     8   (0)| 00:00:01 |
|   2 |   MERGE JOIN CARTESIAN  |      |     1 |    26 |     4   (0)| 00:00:01 |
|   3 |    TABLE ACCESS FULL    | T1   |     1 |    13 |     2   (0)| 00:00:01 |
|   4 |    BUFFER SORT      |      |     1 |    13 |     2   (0)| 00:00:01 |
|   5 |     TABLE ACCESS FULL   | T2   |     1 |    13 |     2   (0)| 00:00:01 |

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
|   6 |   BUFFER SORT       |      |     1 |    26 |     6   (0)| 00:00:01 |
|   7 |    VIEW         |      |     1 |    26 |     4   (0)| 00:00:01 |
|   8 |     MERGE JOIN CARTESIAN|      |     1 |    26 |     4   (0)| 00:00:01 |
|   9 |      TABLE ACCESS FULL  | T3   |     1 |    13 |     2   (0)| 00:00:01 |
|  10 |      BUFFER SORT    |      |     1 |    13 |     2   (0)| 00:00:01 |
|  11 |       TABLE ACCESS FULL | T4   |     1 |    13 |     2   (0)| 00:00:01 |
--------------------------------------------------------------------------------

Outline Data
-------------


PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
  /*+
      BEGIN_OUTLINE_DATA
      USE_MERGE_CARTESIAN(@"SEL$2" "T4"@"SEL$2")
      LEADING(@"SEL$2" "T3"@"SEL$2" "T4"@"SEL$2")
      FULL(@"SEL$2" "T4"@"SEL$2")
      FULL(@"SEL$2" "T3"@"SEL$2")
      USE_MERGE_CARTESIAN(@"SEL$1" "TT"@"SEL$1")
      USE_MERGE_CARTESIAN(@"SEL$1" "T2"@"SEL$1")
      LEADING(@"SEL$1" "T1"@"SEL$1" "T2"@"SEL$1" "TT"@"SEL$1")
      NO_ACCESS(@"SEL$1" "TT"@"SEL$1")
      FULL(@"SEL$1" "T2"@"SEL$1")

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
      FULL(@"SEL$1" "T1"@"SEL$1")
      OUTLINE_LEAF(@"SEL$1")
      OUTLINE_LEAF(@"SEL$2")
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

Note

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------
-----
   - dynamic sampling used for this statement (level=2)

46 rows selected.
</code></pre>

<h2>指定ordered hint的情况</h2>

<pre><code class="sql">SQL&gt; explain plan into plan_table for select /*+ordered*/ * from t1,t2;

Explained.

SQL&gt; SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY(NULL, NULL, 'outline'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
Plan hash value: 787647388

-----------------------------------------------------------------------------
| Id  | Operation        | Name | Rows  | Bytes | Cost (%CPU)| Time     |
-----------------------------------------------------------------------------
|   0 | SELECT STATEMENT     |      |     1 |    26 |     4   (0)| 00:00:01 |
|   1 |  MERGE JOIN CARTESIAN|      |     1 |    26 |     4   (0)| 00:00:01 |
|   2 |   TABLE ACCESS FULL  | T1   |     1 |    13 |     2   (0)| 00:00:01 |
|   3 |   BUFFER SORT        |      |     1 |    13 |     2   (0)| 00:00:01 |
|   4 |    TABLE ACCESS FULL | T2   |     1 |    13 |     2   (0)| 00:00:01 |
-----------------------------------------------------------------------------

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_MERGE_CARTESIAN(@"SEL$1" "T2"@"SEL$1")
      LEADING(@"SEL$1" "T1"@"SEL$1" "T2"@"SEL$1")
      FULL(@"SEL$1" "T2"@"SEL$1")
      FULL(@"SEL$1" "T1"@"SEL$1")
      OUTLINE_LEAF(@"SEL$1")

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

28 rows selected.
</code></pre>

<h2>update outline输出</h2>

<pre><code class="sql">SQL&gt; explain plan into plan_table for update  t1 set c1= 100 where c1=1 ;

Explained.

SQL&gt; select * from table(dbms_xplan.display('PLAN_TABLE',NULL,'OUTLINE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
Plan hash value: 2927627013

---------------------------------------------------------------------------
| Id  | Operation      | Name | Rows  | Bytes | Cost (%CPU)| Time     |
---------------------------------------------------------------------------
|   0 | UPDATE STATEMENT   |      | 1 |    13 | 2   (0)| 00:00:01 |
|   1 |  UPDATE        | T1   |   |   |        |      |
|*  2 |   TABLE ACCESS FULL| T1   | 1 |    13 | 2   (0)| 00:00:01 |
---------------------------------------------------------------------------

Outline Data

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
-------------

  /*+
      BEGIN_OUTLINE_DATA
      FULL(@"UPD$1" "T1"@"UPD$1")
      OUTLINE_LEAF(@"UPD$1")
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------
  */

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - filter("C1"=1)

28 rows selected.
</code></pre>

<h2>Oracle对于USE_HASH_AGGREGATION和NO_USE_HASH_AGGREGATION的使用</h2>

<pre><code class="sql">SQL&gt; select name , version from v$sql_hint where class like '%HASH%';

NAME                                 VERSION
---------------------------------------------------------------- -------------------------
USE_HASH_AGGREGATION                         10.2.0.1
NO_USE_HASH_AGGREGATION                      10.2.0.1
NO_USE_HASH                          10.1.0.3
USE_HASH_GBY_FOR_PUSHDOWN                    11.2.0.2
NO_USE_HASH_GBY_FOR_PUSHDOWN                     11.2.0.2
</code></pre>

<p>使用USE_HASH_AGGREGATION,看能否生效。</p>

<pre><code class="sql">SQL&gt; explain plan into plan_table for select /*+ USE_HASH_AGGREGATION(@SEL$1)*/max(c1) from t1 group by c1;

Explained.

SQL&gt; select * from table(dbms_xplan.display('plan_table',NULL,'OUTLINE'));

PLAN_TABLE_OUTPUT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 274432217

---------------------------------------------------------------------------------
| Id  | Operation    | Name     | Rows  | Bytes | Cost (%CPU)| Time |
---------------------------------------------------------------------------------
|   0 | SELECT STATEMENT |      |     1 |    13 |     0   (0)| 00:00:01 |
|   1 |  HASH GROUP BY   |      |     1 |    13 |     0   (0)| 00:00:01 |
|   2 |   INDEX FULL SCAN| SYS_C0012306 |     1 |    13 |     0   (0)| 00:00:01 |
---------------------------------------------------------------------------------

Outline Data
-------------

  /*+
      BEGIN_OUTLINE_DATA
      USE_HASH_AGGREGATION(@"SEL$1")
      INDEX(@"SEL$1" "T1"@"SEL$1" ("T1"."C1"))
      OUTLINE_LEAF(@"SEL$1")
      ALL_ROWS
      DB_VERSION('11.2.0.2')
      OPTIMIZER_FEATURES_ENABLE('11.2.0.2')
      IGNORE_OPTIM_EMBEDDED_HINTS
      END_OUTLINE_DATA
  */

24 rows selected.
</code></pre>

<p>可见，成功使用该HINT。 oracle的当前版本如下。</p>

<pre><code class="sql">
SQL&gt; select * from v$version;

BANNER
--------------------------------------------------------------------------------
Oracle Database 11g Enterprise Edition Release 11.2.0.2.0 - 64bit Production
PL/SQL Release 11.2.0.2.0 - Production
CORE    11.2.0.2.0  Production
TNS for Linux: Version 11.2.0.2.0 - Production
NLSRTL Version 11.2.0.2.0 - Production
</code></pre>
]]></content>
  </entry>
  
</feed>
